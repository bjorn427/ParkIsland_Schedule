<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Park Island / MTR Schedule App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --app-accent-color: #498189;
            --app-accent-color-darker: #3A6B73;
            --app-nav-background: #eff5f6;
            --app-nav-icon-active-bg: #CDE2F0; 
            --app-icon-active-color: white; 
            --app-icon-inactive-color: #6B7280; 
            --app-text-active-color: var(--app-accent-color); 
            --app-text-inactive-color: #6B7280; 
            --app-select-background: #eff5f6; 
        }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; 
            padding-bottom: 60px; /* Space for bottom nav */
            background-color: #f7f7f7; 
            color: #333333; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        main {
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 0.75rem; 
            display: flex; /* Ensure main itself is a flex container for its children (the panes) */
            flex-direction: column; /* Stack panes vertically if multiple were somehow active (though only one should be) */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            main {
                padding: 1rem; 
            }
        }

        /* Schedule Pane: Uses flex-grow to fill 'main' */
        .content-pane#schedule-pane.active { 
            display: flex; 
            flex-direction: column;
            flex-grow: 1; /* Let this pane grow to fill available space in main */
            overflow: hidden; /* Prevent this pane itself from scrolling */
            min-height: 0; /* Important for nested flex growth */
        }
        /* Schedule Content Wrapper (the card): Grows to fill schedule-pane */
        .content-pane#schedule-pane.active > .schedule-content-wrapper { 
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            overflow: hidden; 
            min-height: 0;
            max-height: 70vh; 
        }
        /* Static Bus Schedule Table Container: Grows to fill remaining space in card, scrolls its content */
        #static-bus-schedule-table-container {
            flex-grow: 1; 
            overflow-y: auto; 
            min-height: 0;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cccccc; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #bbbbbb; 
        }
        /* Custom Select Styling */
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%22%2016%22%3E%3Cpath%20fill%3D%22%23666666%22%20d%3D%22M4.5%206L8%209.5L11.5%206H4.5z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 10px auto;
            padding-right: 2rem; 
            border: 1px solid #d1d5db; 
            background-color: var(--app-select-background); 
            border-radius: 6px; 
            color: #333333;
            font-weight: 400; 
            font-size: 0.875rem; 
        }
        select:focus {
            outline: none;
            border-color: var(--app-accent-color); 
            box-shadow: 0 0 0 2px rgba(73, 129, 137, 0.2); 
        }

        /* Bottom Navigation Styling */
        .bottom-nav-button {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 6px; 
            padding-bottom: 4px;
            flex: 1;
            transition: color 0.2s ease-in-out;
        }
        .bottom-nav-icon-wrapper {
            width: 56px; 
            height: 32px; 
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px; 
            margin-bottom: 1px; 
            transition: background-color 0.2s ease-in-out;
        }
        .bottom-nav-button svg {
            stroke: var(--app-icon-inactive-color);
            transition: stroke 0.2s ease-in-out;
            width: 24px; 
            height: 24px; 
        }
        .bottom-nav-button .nav-text {
            font-size: 0.75rem; 
            color: var(--app-text-inactive-color);
            transition: color 0.2s ease-in-out, font-weight 0.2s ease-in-out;
        }

        .bottom-nav-button.active .bottom-nav-icon-wrapper {
            background-color: var(--app-nav-icon-active-bg);
        }
        .bottom-nav-button.active svg {
            stroke: var(--app-accent-color); 
        }
        .bottom-nav-button.active .nav-text {
            color: var(--app-text-active-color); 
            font-weight: 600; 
        }
        
        /* Content Pane Transitions */
        .content-pane {
            display: none; 
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .content-pane.active {
            display: block; /* Default display for active panes */
            opacity: 1;
        }
        
        /* Static Schedule Table Styling */
        .static-schedule-header-fixed {
            display: flex;
            padding-top: 6px; 
            padding-bottom: 3px;
            background-color: #f0f0f0; 
            border-bottom: 1px solid #dddddd;
            font-weight: 500;
            font-size: 0.75rem; 
            position: sticky; 
            top: 0; 
            z-index: 20; 
        }
        .static-schedule-header-fixed .hour-header {
            width: 25%; 
            text-align: left;
            padding-left: 0.5rem; 
            box-sizing: border-box; 
        }
        .static-schedule-header-fixed .minutes-header {
            width: 75%; 
            text-align: left;
            padding-left: 0.5rem; 
            box-sizing: border-box; 
        }

        .static-schedule-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .static-schedule-table td { 
            border-bottom: 1px solid #eeeeee;
            padding: 4px 0.5rem; 
            text-align: left; 
            font-weight: 400;
            vertical-align: top; 
            box-sizing: border-box; 
        }
        .static-schedule-table td.hour-cell {
            font-weight: 600; 
            font-size: 0.75rem; 
            width: 25%; 
        }
        .static-schedule-table td.minutes-cell {
            font-size: 0.75rem; 
            line-height: 1.5; 
            width: 75%; 
        }
        .static-schedule-table .minute-item {
            display: inline-block;
            margin-right: 4px; 
            margin-bottom: 1px;
        }
        .static-schedule-table tr:last-child td {
            border-bottom: none;
        }
        .text-now-emphasis {
            color: var(--app-accent-color);
            font-weight: 600; 
        }
        /* Custom Card Style */
        .card-ive {
            background-color: #ffffff; 
            border-radius: 10px; 
            border: 1px solid #e8e8e8; 
        }
         /* Custom Button Style */
        .button-ive {
            background-color: var(--app-accent-color);
            color: #ffffff; 
            transition: background-color 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            border-radius: 8px; 
            padding: 0.55rem 1rem; 
            text-transform: none; 
            letter-spacing: normal;
        }
        .button-ive:hover {
            background-color: var(--app-accent-color-darker);
        }
        /* Custom Bottom Nav Bar Style */
        .bottom-nav-ive {
            background-color: var(--app-nav-background); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.08); 
        }
        
        /* Segmented Control for Schedule Type */
        .segmented-control-container {
            display: flex;
            background-color: #e9ecef; 
            border-radius: 8px;
            padding: 3px;
            width: 100%; 
        }
        .schedule-type-segment {
            padding: 0.35rem 0.75rem; 
            border-radius: 6px; 
            background-color: transparent;
            color: #495057; 
            font-size: 0.75rem; 
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.25s cubic-bezier(0.4,0,0.2,1), color 0.25s cubic-bezier(0.4,0,0.2,1), box-shadow 0.25s cubic-bezier(0.4,0,0.2,1);
            text-align: center;
            flex-grow: 1; 
        }
        .schedule-type-segment.active { 
            background-color: #ffffff; 
            color: var(--app-accent-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06); 
        }
        .schedule-type-segment:hover:not(.active) { 
            background-color: rgba(0,0,0,0.04); 
        }
        .loading-text {
            color: #6b7280; 
            font-style: italic;
        }
        #settings-saved-message {
            position: absolute;
            top: 1rem; 
            right: 1rem; 
            background-color: #10B981; /* Tailwind green-500 */
            color: white;
            padding: 0.5rem 1rem; 
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #settings-saved-message.show {
            opacity: 1;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800"> 
    <div class="min-h-screen flex flex-col"> 
        <main> 
            <div id="home-pane" class="content-pane"> 
                <div id="time-card" class="card-ive min-h-[60px] sm:min-h-[70px] rounded-xl p-2 sm:p-3 flex flex-col justify-center items-center mb-3 sm:mb-4">
                    <div id="current-time" class="text-xl sm:text-3xl font-medium text-gray-900">--:-- --</div>
                    <div id="current-day-date" class="text-sm text-gray-500 mt-0.5">----------, ---------- --, ----</div>
                </div>
                <div class="grid grid-cols-1 gap-3 sm:gap-4">
                    <div id="bus-schedule-card" class="card-ive rounded-xl p-3 sm:p-4 flex flex-col">
                        <h2 class="text-sm sm:text-base font-semibold text-gray-800 mb-2 sm:mb-2.5">Park Island Departures</h2>
                        <select id="bus-route-select" class="w-full p-2 sm:p-2.5 border rounded-lg mb-2 sm:mb-2.5 text-sm"></select>
                        <div id="bus-schedule-display" class="flex flex-row gap-3 sm:gap-4 flex-grow">
                            <div class="w-1/2 flex flex-col">
                                <h3 id="bus-direction1-name" class="text-sm font-semibold text-gray-600 sticky top-0 bg-white/90 backdrop-blur-sm pb-1 z-10">Direction 1</h3>
                                <div class="border-b border-gray-200 mb-1.5"></div> 
                                <ul id="bus-direction1-times" class="space-y-0.5 text-gray-700 flex-grow overflow-y-auto pr-1 max-h-[110px] sm:max-h-[120px] md:max-h-[130px]"></ul>
                            </div>
                            <div class="w-1/2 flex flex-col"> 
                                <h3 id="bus-direction2-name" class="text-sm font-semibold text-gray-600 sticky top-0 bg-white/90 backdrop-blur-sm pb-1 z-10">Direction 2</h3>
                                <div class="border-b border-gray-200 mb-1.5"></div> 
                                <ul id="bus-direction2-times" class="space-y-0.5 text-gray-700 flex-grow overflow-y-auto pr-1 max-h-[110px] sm:max-h-[120px] md:max-h-[130px]"></ul>
                            </div>
                        </div>
                    </div>
                    <div id="train-schedule-card" class="card-ive rounded-xl p-3 sm:p-4 flex flex-col">
                        <h2 class="text-sm sm:text-base font-semibold text-gray-800 mb-2 sm:mb-2.5">Train Departures</h2>
                        <select id="train-line-select" class="w-full p-2 sm:p-2.5 border rounded-lg mb-2 text-sm"></select>
                        <select id="train-station-select" class="w-full p-2 sm:p-2.5 border rounded-lg mb-2 sm:mb-2.5 text-sm"></select>
                        <div id="train-schedule-display" class="flex flex-row gap-3 sm:gap-4 flex-grow">
                            <div class="w-1/2 flex flex-col">
                                <h3 id="train-direction1-name" class="text-sm font-semibold text-gray-600 sticky top-0 bg-white/90 backdrop-blur-sm pb-1 z-10">Direction 1</h3>
                                <div class="border-b border-gray-200 mb-1.5"></div> 
                                <ul id="train-direction1-times" class="space-y-0.5 text-gray-700 flex-grow overflow-y-auto pr-1 max-h-[110px] sm:max-h-[120px] md:max-h-[130px]"><li class="loading-text text-sm">Loading...</li></ul>
                            </div>
                            <div class="w-1/2 flex flex-col"> 
                                <h3 id="train-direction2-name" class="text-sm font-semibold text-gray-600 sticky top-0 bg-white/90 backdrop-blur-sm pb-1 z-10">Direction 2</h3>
                                <div class="border-b border-gray-200 mb-1.5"></div> 
                                <ul id="train-direction2-times" class="space-y-0.5 text-gray-700 flex-grow overflow-y-auto pr-1 max-h-[110px] sm:max-h-[120px] md:max-h-[130px]"><li class="loading-text text-sm">Loading...</li></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="schedule-pane" class="content-pane"> 
                <div id="time-card-schedule" class="card-ive min-h-[60px] sm:min-h-[70px] rounded-xl p-2 sm:p-3 flex flex-col justify-center items-center mb-3 sm:mb-4 flex-shrink-0">
                    <div id="current-time-schedule" class="text-xl sm:text-3xl font-medium text-gray-900">--:-- --</div>
                    <div id="current-day-date-schedule" class="text-sm text-gray-500 mt-0.5">----------, ---------- --, ----</div>
                </div>
                <div class="card-ive rounded-xl p-3 sm:p-4 md:p-6 flex flex-col schedule-content-wrapper"> 
                    <h2 class="text-sm sm:text-lg font-medium text-gray-700 mb-3 sm:mb-4 flex-shrink-0">Full Park Island Schedules</h2>
                    <select id="static-bus-route-select" class="w-full p-2 sm:p-3 border rounded-lg mb-4 text-sm flex-shrink-0">
                        <option value="">Select a Route and Direction</option> 
                    </select>
                    <div id="schedule-type-selector-container" class="segmented-control-container mb-4 flex-shrink-0"> 
                        <button data-scheduletype="weekday" class="schedule-type-segment active">Weekday</button>
                        <button data-scheduletype="saturday" class="schedule-type-segment">Saturday</button>
                        <button data-scheduletype="sundayPublicHoliday" class="schedule-type-segment">Sun/PH</button>
                    </div>
                    <div id="static-schedule-fixed-header" class="static-schedule-header-fixed flex-shrink-0">
                        <div class="hour-header">Hour</div>
                        <div class="minutes-header">Minutes</div>
                    </div>
                    <div id="static-bus-schedule-table-container" class="static-schedule-table">
                        <p class="text-gray-500 text-sm px-2 sm:px-3">Please select a route, direction, and schedule type.</p>
                    </div>
                </div>
            </div>

            <div id="settings-pane" class="content-pane">
                <div class="card-ive rounded-xl p-3 sm:p-4 md:p-6 relative"> 
                    <p id="settings-saved-message" class="hidden">Settings saved!</p>
                    <h2 class="text-sm sm:text-lg font-medium text-gray-700 mb-4 sm:mb-6">Settings</h2>
                    <div class="space-y-5">
                        <div>
                            <label for="favorite-bus-route-select" class="block text-sm font-medium text-gray-700 mb-1.5">Favorite Park Island Route</label>
                            <select id="favorite-bus-route-select" class="w-full p-2 sm:p-3 border rounded-lg text-sm">
                                <option value="">None</option>
                            </select>
                            <button id="save-favorite-bus" class="button-ive mt-2.5 px-4 text-sm">Save Route Preference</button>
                        </div>
                        <div>
                            <label for="favorite-train-line-select" class="block text-sm font-medium text-gray-700 mb-1.5">Favorite Train Line</label>
                            <select id="favorite-train-line-select" class="w-full p-2 sm:p-3 border rounded-lg text-sm">
                                <option value="">None</option>
                            </select>
                             <label for="favorite-train-station-select" class="block text-sm font-medium text-gray-700 mb-1.5 mt-3">Favorite Station on this Line</label>
                            <select id="favorite-train-station-select" class="w-full p-2 sm:p-3 border rounded-lg text-sm">
                                <option value="">None</option>
                            </select>
                            <button id="save-favorite-train" class="button-ive mt-2.5 px-4 text-sm">Save Train Preference</button>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-sm sm:text-base font-medium text-gray-700 mb-2">About This App</h3>
                        <p class="text-gray-600 text-sm leading-relaxed">TransitApp provides real-time departure information to streamline your commute, focusing on clarity and ease of use.</p>
                        <p class="text-gray-600 mt-2 text-sm">Version: 5.6.0 "Adjusted Schedule Height"</p>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav-ive fixed bottom-0 left-0 w-full z-30">
            <div class="max-w-md mx-auto flex justify-around items-center h-16"> 
                <button data-tab="home" class="bottom-nav-button"> 
                    <div class="bottom-nav-icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    </div>
                    <span class="nav-text">Home</span>
                </button>
                <button data-tab="schedule" class="bottom-nav-button">
                    <div class="bottom-nav-icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </div>
                    <span class="nav-text">Schedule</span> 
                </button>
                <button data-tab="settings" class="bottom-nav-button">
                    <div class="bottom-nav-icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </div>
                    <span class="nav-text">Settings</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        // Function to parse schedule JSON (hour keys, minute arrays) to HH:MM strings
        function parseScheduleJsonToHHMM(jsonData) {
            const times = [];
            if (!jsonData) return times; // Return empty if no data
            for (const hour in jsonData) {
                if (jsonData.hasOwnProperty(hour)) {
                    const minutesArray = jsonData[hour];
                    minutesArray.forEach(minute => {
                        const formattedHour = String(hour).padStart(2, '0'); // Ensure 2 digits for hour
                        const formattedMinute = String(minute).padStart(2, '0'); // Ensure 2 digits for minute
                        times.push(`${formattedHour}:${formattedMinute}`);
                    });
                }
            }
            return times.sort(); // Sort times chronologically
        }

        // Schedule Data for Tsing Yi <-> Park Island (uses parsing)
        const tsingYiToMaWanWeekdayTimes = parseScheduleJsonToHHMM({"00":[0,15,30,45],"01":[15],"02":[0,45],"03":[30],"04":[15],"05":[0,45],"06":[15,30,40,50],"07":[0,10,20,30,40,50],"08":[0,10,20,30,40,50],"09":[0,10,20,30,40,50],"10":[0,10,20,30,40,50],"11":[0,10,20,30,40,50],"12":[0,10,20,30,40,50],"13":[0,10,20,30,40,50],"14":[0,10,20,30,40,50],"15":[0,10,20,30,40,50],"16":[0,6,12,18,24,30,36,42,48,54],"17":[0,5,10,15,20,25,30,35,40,45,50,55],"18":[0,5,10,15,20,25,30,35,40,45,50,55],"19":[0,5,10,15,20,25,30,35,40,45,50,55],"20":[0,6,12,18,24,30,36,42,48,54],"21":[0,6,12,18,24,30,36,42,48,54],"22":[0,6,12,18,24,30,36,42,48,54],"23":[0,6,12,18,24,30,40,50]});
        const tsingYiToMaWanSaturdayTimes = parseScheduleJsonToHHMM({"00":[0,15,30,45],"01":[15],"02":[0,45],"03":[30],"04":[15],"05":[0,45],"06":[15,30,40,50],"07":[0,10,20,30,40,50],"08":[0,10,20,30,40,50],"09":[0,10,20,30,40,50],"10":[0,6,12,18,24,30,36,42,48,54],"11":[0,5,10,15,20,25,30,35,40,45,50,55],"12":[0,5,10,15,20,25,30,35,40,45,50,55],"13":[0,6,12,18,24,30,36,42,48,54],"14":[0,6,12,18,24,30,36,42,48,54],"15":[0,6,12,18,24,30,36,42,48,54],"16":[0,6,12,18,24,30,36,42,48,54],"17":[0,5,10,15,20,25,30,35,40,45,50,55],"18":[0,5,10,15,20,25,30,35,40,45,50,55],"19":[0,6,12,18,24,30,36,42,48,54],"20":[0,6,12,18,24,30,36,42,48,54],"21":[0,6,12,18,24,30,36,42,48,54],"22":[0,6,12,18,24,30,36,42,48,54],"23":[0,6,12,18,24,30,40,50]});
        const tsingYiToMaWanHolidayTimes = parseScheduleJsonToHHMM ({"00":[0,15,30,45],"01":[15],"02":[0,45],"03":[30],"04":[15],"05":[0,45],"06":[15,30,40,50],"07":[0,10,20,30,40,50],"08":[0,10,20,30,40,50],"09":[0,10,20,30,40,50],"10":[0,6,12,18,24,30,36,42,48,54],"11":[0,5,10,15,20,25,30,35,40,45,50,55],"12":[0,5,10,15,20,25,30,35,40,45,50,55],"13":[0,6,12,18,24,30,36,42,48,54],"14":[0,6,12,18,24,30,36,42,48,54],"15":[0,6,12,18,24,30,36,42,48,54],"16":[0,6,12,18,24,30,36,42,48,54],"17":[0,5,10,15,20,25,30,35,40,45,50,55],"18":[0,5,10,15,20,25,30,35,40,45,50,55],"19":[0,6,12,18,24,30,36,42,48,54],"20":[0,6,12,18,24,30,36,42,48,54],"21":[0,6,12,18,24,30,36,42,48,54],"22":[0,6,12,18,24,30,36,42,48,54],"23":[0,6,12,18,24,30,40,50]});
        
        const maWanToTsingYiWeekdayTimes = parseScheduleJsonToHHMM({"00":[0,15,30],"01":[0,45],"02":[30],"03":[15],"04":[0,45],"05":[30],"06":[0,15,30,35,40,45,50,55],"07":[0,5,10,15,20,25,30,34,38,42,46,50,54,58],"08":[2,6,10,14,18,22,26,30,35,40,45,50,55],"09":[0,5,10,15,20,25,30,35,40,45,50,55],"10":[0,10,20,30,40,50],"11":[0,10,20,30,40,50],"12":[0,10,20,30,40,50],"13":[0,10,20,30,40,50],"14":[0,10,20,30,40,50],"15":[0,10,20,30,40,50],"16":[0,6,12,18,24,30,36,42,48,54],"17":[0,6,12,18,24,30,36,42,48,54],"18":[0,6,12,18,24,30,36,42,48,54],"19":[0,6,12,18,24,30,36,42,48,54],"20":[0,12,24,36,48],"21":[0,12,24,36,48],"22":[0,12,24,36,48],"23":[0,15,30,45]});
        const maWanToTsingYiSaturdayTimes = parseScheduleJsonToHHMM({"00":[0,15,30],"01":[0,45],"02":[30],"03":[15],"04":[0,45],"05":[30],"06":[0,15,30,40,50],"07":[0,10,20,30,35,40,45,50,55],"08":[0,5,10,15,20,25,30,35,40,45,50,55],"09":[0,6,12,18,24,30,36,42,48,54],"10":[0,6,12,18,24,30,36,42,48,54],"11":[0,5,10,15,20,25,30,35,40,45,50,55],"12":[0,5,10,15,20,25,30,35,40,45,50,55],"13":[0,6,12,18,24,30,36,42,48,54],"14":[0,6,12,18,24,30,36,42,48,54],"15":[0,6,12,18,24,30,36,42,48,54],"16":[0,6,12,18,24,30,36,42,48,54],"17":[0,5,10,15,20,25,30,35,40,45,50,55],"18":[0,5,10,15,20,25,30,35,40,45,50,55],"19":[0,6,12,18,24,30,36,42,48,54],"20":[0,12,24,36,48],"21":[0,12,24,36,48],"22":[0,12,24,36,48],"23":[0,15,30,45]});
        const maWanToTsingYiHolidayTimes = parseScheduleJsonToHHMM({"00":[0,15,30],"01":[0,45],"02":[30],"03":[15],"04":[0,45],"05":[30],"06":[0,15,30,40,50],"07":[0,10,20,30,35,40,45,50,55],"08":[0,5,10,15,20,25,30,35,40,45,50,55],"09":[0,6,12,18,24,30,36,42,48,54],"10":[0,6,12,18,24,30,36,42,48,54],"11":[0,5,10,15,20,25,30,35,40,45,50,55],"12":[0,5,10,15,20,25,30,35,40,45,50,55],"13":[0,6,12,18,24,30,36,42,48,54],"14":[0,6,12,18,24,30,36,42,48,54],"15":[0,6,12,18,24,30,36,42,48,54],"16":[0,6,12,18,24,30,36,42,48,54],"17":[0,5,10,15,20,25,30,35,40,45,50,55],"18":[0,5,10,15,20,25,30,35,40,45,50,55],"19":[0,6,12,18,24,30,36,42,48,54],"20":[0,12,24,36,48],"21":[0,12,24,36,48],"22":[0,12,24,36,48],"23":[0,15,30,45]});

        // MTR API Configuration
        const mtrApiConfig = {
            "Tung Chung Line": { 
                apiLineCode: "TCL", 
                endpoint1NameForDisplay: "To Hong Kong", 
                endpoint1ActualDestCode: "HOK", 
                endpoint2NameForDisplay: "To Tung Chung", 
                endpoint2ActualDestCode: "TUC", 
                defaultStationName: "Tsing Yi",
                stations: { 
                    "Tung Chung": "TUC", "Sunny Bay": "SUN", "Tsing Yi": "TSY", "Lai King": "LAK", 
                    "Nam Cheong": "NAC", "Olympic": "OLY", "Kowloon": "KOW", "Hong Kong": "HOK"
                } 
            },
            "Tsuen Wan Line": { apiLineCode: "TWL", endpoint1NameForDisplay: "To Central", endpoint1ActualDestCode: "CEN", endpoint2NameForDisplay: "To Tsuen Wan", endpoint2ActualDestCode: "TSW", defaultStationName: "Kwai Fong", stations: { "Central": "CEN", "Admiralty": "ADM", "Tsim Sha Tsui": "TST", "Jordan": "JOR", "Yau Ma Tei": "YMT", "Mong Kok": "MOK", "Prince Edward": "PRE", "Sham Shui Po": "SSP", "Cheung Sha Wan": "CSW", "Lai Chi Kok": "LCK", "Mei Foo": "MEF", "Lai King": "LAK", "Kwai Fong": "KWF", "Kwai Hing": "KWH", "Tai Wo Hau": "TWH", "Tsuen Wan": "TSW"} },
            "Island Line": { apiLineCode: "ISL", endpoint1NameForDisplay: "To Kennedy Town", endpoint1ActualDestCode: "KET", endpoint2NameForDisplay: "To Chai Wan", endpoint2ActualDestCode: "CHW", defaultStationName: "Central", stations: { "Kennedy Town": "KET", "HKU": "HKU", "Sai Ying Pun": "SYP", "Sheung Wan": "SHW", "Central": "CEN", "Admiralty": "ADM", "Wan Chai": "WAC", "Causeway Bay": "CAB", "Tin Hau": "TIH", "Fortress Hill": "FOH", "North Point": "NOP", "Quarry Bay": "QUB", "Tai Koo": "TAK", "Sai Wan Ho": "SWH", "Shau Kei Wan": "SKW", "Heng Fa Chuen": "HFC", "Chai Wan": "CHW"} },
            "Tuen Ma Line": { apiLineCode: "TML", endpoint1NameForDisplay: "To Tuen Mun", endpoint1ActualDestCode: "TUM", endpoint2NameForDisplay: "To Wu Kai Sha", endpoint2ActualDestCode: "WKS", defaultStationName: "Nam Cheong", stations: {"Wu Kai Sha": "WKS", "Ma On Shan": "MOS", "Heng On": "HEO", "Tai Shui Hang": "TSH", "Shek Mun": "SHM", "City One": "CIO", "Sha Tin Wai": "STW", "Che Kung Temple": "CKT", "Tai Wai": "TAW", "Hin Keng": "HIK", "Diamond Hill": "DIH", "Kai Tak": "KAT", "Sung Wong Toi": "SUW", "To Kwa Wan": "TKW", "Ho Man Tin": "HOM", "Hung Hom": "HUH", "East Tsim Sha Tsui": "ETS", "Austin": "AUS", "Nam Cheong": "NAC", "Mei Foo": "MEF", "Tsuen Wan West": "TWW", "Kam Sheung Road": "KSR", "Yuen Long": "YUL", "Long Ping": "LOP", "Tin Shui Wai": "TIS", "Siu Hong": "SIH", "Tuen Mun": "TUM"}},
            "Airport Express": { apiLineCode: "AEL", endpoint1NameForDisplay: "To AsiaWorld Expo", endpoint1ActualDestCode: "AWE", endpoint2NameForDisplay: "To Hong Kong", endpoint2ActualDestCode: "HOK", defaultStationName: "Tsing Yi", stations: { "Hong Kong": "HOK", "Kowloon": "KOW", "Tsing Yi": "TSY", "Airport": "AIR", "AsiaWorld Expo": "AWE"}},
            "Tseung Kwan O Line": { apiLineCode: "TKL", endpoint1NameForDisplay: "To North Point", endpoint1ActualDestCode: "NOP", endpoint2NameForDisplay: "To Po Lam / LOHAS Park", endpoint2ActualDestCode: ["POA", "LHP"], defaultStationName: "Tseung Kwan O", stations: {"North Point": "NOP", "Quarry Bay": "QUB", "Yau Tong": "YAT", "Tiu Keng Leng": "TIK", "Tseung Kwan O": "TKO", "LOHAS Park": "LHP", "Hang Hau": "HAH", "Po Lam": "POA"}},
            "East Rail Line": { apiLineCode: "EAL", endpoint1NameForDisplay: "To Admiralty", endpoint1ActualDestCode: "ADM", endpoint2NameForDisplay: "To Lo Wu / Lok Ma Chau", endpoint2ActualDestCode: ["LOW", "LMC"], defaultStationName: "Sha Tin", stations: {"Admiralty": "ADM", "Exhibition Centre": "EXC", "Hung Hom": "HUH", "Mong Kok East": "MKK", "Kowloon Tong": "KOT", "Tai Wai": "TAW", "Sha Tin": "SHT", "Fo Tan": "FOT", "Racecourse": "RAC", "University": "UNI", "Tai Po Market": "TAP", "Tai Wo": "TWO", "Fanling": "FAN", "Sheung Shui": "SHS", "Lo Wu": "LOW", "Lok Ma Chau": "LMC"}},
            "South Island Line": { apiLineCode: "SIL", endpoint1NameForDisplay: "To Admiralty", endpoint1ActualDestCode: "ADM", endpoint2NameForDisplay: "To South Horizons", endpoint2ActualDestCode: "SOH", defaultStationName: "Wong Chuk Hang", stations: {"Admiralty": "ADM", "Ocean Park": "OCP", "Wong Chuk Hang": "WCH", "Lei Tung": "LET", "South Horizons": "SOH"}},
            "Kwun Tong Line": { apiLineCode: "KTL", endpoint1NameForDisplay: "To Whampoa", endpoint1ActualDestCode: "WHA", endpoint2NameForDisplay: "To Tiu Keng Leng", endpoint2ActualDestCode: "TIK", defaultStationName: "Prince Edward", stations: {"Whampoa": "WHA", "Ho Man Tin": "HOM", "Yau Ma Tei": "YMT", "Mong Kok": "MOK", "Prince Edward": "PRE", "Shek Kip Mei": "SKM", "Kowloon Tong": "KOT", "Lok Fu": "LOF", "Wong Tai Sin": "WTS", "Diamond Hill": "DIH", "Choi Hung": "CHH", "Kowloon Bay": "KOB", "Ngau Tau Kok": "NTK", "Kwun Tong": "KWT", "Lam Tin": "LAT", "Yau Tong": "YAT", "Tiu Keng Leng": "TIK"}}
        };

        // Create a map from station code to station name for easier lookup if needed
        const stationCodeToNameMap = {};
        Object.values(mtrApiConfig).forEach(line => {
            Object.entries(line.stations).forEach(([name, code]) => {
                stationCodeToNameMap[code] = name;
            });
            const addEndpointToMap = (endpointCode) => {
                if (endpointCode && typeof endpointCode === 'string' && !stationCodeToNameMap[endpointCode]) {
                    let displayName = Object.keys(line.stations).find(key => line.stations[key] === endpointCode);
                    if (!displayName) { 
                        for (const otherLineKey in mtrApiConfig) {
                            const otherLine = mtrApiConfig[otherLineKey];
                            displayName = Object.keys(otherLine.stations).find(key => otherLine.stations[key] === endpointCode);
                            if (displayName) break; 
                        }
                    }
                    stationCodeToNameMap[endpointCode] = displayName || endpointCode; 
                } else if (Array.isArray(endpointCode)) { 
                    endpointCode.forEach(addEndpointToMap); 
                }
            };
            addEndpointToMap(line.endpoint1ActualDestCode);
            addEndpointToMap(line.endpoint2ActualDestCode);
        });

        // Main Schedules Object
        const mockSchedules = { 
            bus: { 
                "Tsing Yi <-> Park Island": { 
                    weekday: { 
                        direction1Name: "To Park Island (Bus)", 
                        direction1Times: tsingYiToMaWanWeekdayTimes,
                        direction2Name: "To Tsing Yi (Bus)", 
                        direction2Times: maWanToTsingYiWeekdayTimes 
                    },
                    saturday: { 
                        direction1Name: "To Park Island (Bus)", 
                        direction1Times: tsingYiToMaWanSaturdayTimes, 
                        direction2Name: "To Tsing Yi (Bus)", 
                        direction2Times: maWanToTsingYiSaturdayTimes 
                    },
                    sundayPublicHoliday: { 
                        direction1Name: "To Park Island (Bus)", 
                        direction1Times: tsingYiToMaWanHolidayTimes, 
                        direction2Name: "To Tsing Yi (Bus)", 
                        direction2Times: maWanToTsingYiHolidayTimes 
                    }
                },
                "Kwai Fong <-> Park Island": { // Data provided by user
                    "weekday": {
                        "direction1Name": "To Park Island (Bus)",
                        "direction1Times": [
                            "00:00", "00:30", "01:00", "01:25", "02:10", "02:55", "03:40", "04:25", "04:55", "05:10", "05:55",
                            "06:20", "06:35", "06:45", "06:55",
                            "07:05", "07:15", "07:25", "07:35", "07:45", "07:55",
                            "08:05", "08:15", "08:25", "08:35", "08:45", "08:55",
                            "09:05", "09:15", "09:25", "09:35", "09:45",
                            "10:00", "10:12", "10:24", "10:36", "10:48",
                            "11:00", "11:12", "11:24", "11:36", "11:48",
                            "12:00", "12:12", "12:24", "12:36", "12:48",
                            "13:00", "13:12", "13:24", "13:36", "13:48",
                            "14:00", "14:12", "14:24", "14:36", "14:48",
                            "15:00", "15:12", "15:24", "15:36", "15:48",
                            "16:00", "16:12", "16:24", "16:36", "16:48",
                            "17:00", "17:10", "17:20", "17:30", "17:40", "17:50", "17:58",
                            "18:06", "18:14", "18:22", "18:30", "18:38", "18:46", "18:54",
                            "19:02", "19:10", "19:18", "19:26", "19:34", "19:42", "19:50", "19:58",
                            "20:06", "20:14", "20:22", "20:30", "20:38", "20:46", "20:54",
                            "21:02", "21:10", "21:18", "21:26", "21:34", "21:42", "21:50", "21:58",
                            "22:06", "22:14", "22:22", "22:30", "22:38", "22:46", "22:54",
                            "23:02", "23:15", "23:30", "23:45"
                        ],
                        "direction2Name": "To Kwai Fong (Bus)",
                        "direction2Times": [
                            "00:00", "00:15", "00:45", "01:00", "01:45", "02:30", "03:15", "04:00",
                            "04:45", "05:30", "06:00", "06:15", "06:30", "06:40", "06:50", "07:00",
                            "07:10", "07:20", "07:30", "07:40", "07:50", "08:00", "08:10", "08:20",
                            "08:30", "08:40", "08:50", "09:00", "09:10", "09:20", "09:30", "09:45",
                            "10:00", "10:12", "10:24", "10:36", "10:48", "11:00", "11:12", "11:24",
                            "11:36", "11:48", "12:00", "12:12", "12:24", "12:36", "12:48", "13:00",
                            "13:12", "13:24", "13:36", "13:48", "14:00", "14:12", "14:24", "14:36",
                            "14:48", "15:00", "15:12", "15:24", "15:36", "15:48", "16:00", "16:12",
                            "16:24", "16:36", "16:48", "17:00", "17:10", "17:20", "17:30", "17:40",
                            "17:50", "18:00", "18:10", "18:20", "18:30", "18:40", "18:50", "19:00",
                            "19:12", "19:24", "19:36", "19:48", "20:00", "20:12", "20:24", "20:36",
                            "20:48", "21:00", "21:12", "21:24", "21:36", "21:48", "22:00", "22:12",
                            "22:24", "22:36", "22:48", "23:00", "23:15", "23:30", "23:45"
                        ]
                    },
                    "saturday": {
                        "direction1Name": "To Park Island (Bus)",
                        "direction1Times": [
                            "00:00", "00:30", "01:00", "01:25", "02:10", "02:55", "03:40", "04:25", "04:55", "05:10", "05:55",
                            "06:20", "06:35", "06:45", "06:55",
                            "07:05", "07:15", "07:25", "07:35", "07:45", "07:55",
                            "08:05", "08:15", "08:25", "08:35", "08:45", "08:55",
                            "09:05", "09:15", "09:25", "09:35", "09:45",
                            "10:00", "10:12", "10:24", "10:36", "10:48",
                            "11:00", "11:12", "11:24", "11:36", "11:48",
                            "12:00", "12:12", "12:24", "12:36", "12:48",
                            "13:00", "13:12", "13:24", "13:36", "13:48",
                            "14:00", "14:12", "14:24", "14:36", "14:48",
                            "15:00", "15:12", "15:24", "15:36", "15:48",
                            "16:00", "16:12", "16:24", "16:36", "16:48",
                            "17:00", "17:10", "17:20", "17:30", "17:40", "17:50",
                            "18:00", "18:10", "18:20", "18:30", "18:38", "18:46", "18:54",
                            "19:02", "19:10", "19:18", "19:26", "19:34", "19:42", "19:50", "19:58",
                            "20:06", "20:14", "20:22", "20:30", "20:38", "20:46", "20:54",
                            "21:02", "21:10", "21:18", "21:26", "21:34", "21:42", "21:50", "21:58",
                            "22:06", "22:14", "22:22", "22:30", "22:38", "22:46", "22:54",
                            "23:02", "23:15", "23:30", "23:45"
                        ],
                        "direction2Name": "To Kwai Fong (Bus)",
                        "direction2Times": [
                            "00:00", "00:15", "00:45", "01:00", "01:45", "02:30", "03:15", "04:00",
                            "04:45", "05:30", "06:00", "06:15", "06:30", "06:40", "06:50", "07:00",
                            "07:10", "07:20", "07:30", "07:38", "07:46", "07:54", "08:02", "08:10",
                            "08:18", "08:26", "08:34", "08:42", "08:50", "09:00", "09:10", "09:20",
                            "09:30", "09:40", "09:50", "10:00", "10:12", "10:24", "10:36", "10:48",
                            "11:00", "11:12", "11:24", "11:36", "11:48", "12:00", "12:12", "12:24",
                            "12:36", "12:48", "13:00", "13:12", "13:24", "13:36", "13:48", "14:00",
                            "14:12", "14:24", "14:36", "14:48", "15:00", "15:12", "15:24", "15:36",
                            "15:48", "16:00", "16:12", "16:24", "16:36", "16:48", "17:00", "17:10",
                            "17:20", "17:30", "17:40", "17:50", "18:00", "18:10", "18:20", "18:30",
                            "18:40", "18:50", "19:00", "19:12", "19:24", "19:36", "19:48", "20:00",
                            "20:12", "20:24", "20:36", "20:48", "21:00", "21:12", "21:24", "21:36",
                            "21:48", "22:00", "22:12", "22:24", "22:36", "22:48", "23:00", "23:15",
                            "23:30", "23:45"
                        ]
                    },
                    "sundayPublicHoliday": {
                        "direction1Name": "To Park Island (Bus)",
                        "direction1Times": [
                            "00:00", "00:30", "01:00", "01:25", "02:10", "02:55", "03:40", "04:25", "04:55", "05:10", "05:55",
                            "06:20", "06:35", "06:45", "06:55",
                            "07:05", "07:15", "07:25", "07:35", "07:45", "07:55",
                            "08:05", "08:15", "08:25", "08:35", "08:45", "08:55",
                            "09:05", "09:15", "09:25", "09:35", "09:45",
                            "10:00", "10:12", "10:24", "10:36", "10:48",
                            "11:00", "11:12", "11:24", "11:36", "11:48",
                            "12:00", "12:12", "12:24", "12:36", "12:48",
                            "13:00", "13:12", "13:24", "13:36", "13:48",
                            "14:00", "14:12", "14:24", "14:36", "14:48",
                            "15:00", "15:12", "15:24", "15:36", "15:48",
                            "16:00", "16:12", "16:24", "16:36", "16:48",
                            "17:00", "17:10", "17:20", "17:30", "17:40", "17:50",
                            "18:00", "18:10", "18:20", "18:30", "18:38", "18:46", "18:54",
                            "19:02", "19:10", "19:18", "19:26", "19:34", "19:42", "19:50", "19:58",
                            "20:06", "20:14", "20:22", "20:30", "20:38", "20:46", "20:54",
                            "21:02", "21:10", "21:18", "21:26", "21:34", "21:42", "21:50", "21:58",
                            "22:06", "22:14", "22:22", "22:30", "22:38", "22:46", "22:54",
                            "23:02", "23:15", "23:30", "23:45"
                        ],
                        "direction2Name": "To Kwai Fong (Bus)",
                        "direction2Times": [
                            "00:00", "00:15", "00:45", "01:00", "01:45", "02:30", "03:15", "04:00",
                            "04:45", "05:30", "06:00", "06:15", "06:30", "06:40", "06:50", "07:00",
                            "07:10", "07:20", "07:30", "07:38", "07:46", "07:54", "08:02", "08:10",
                            "08:18", "08:26", "08:34", "08:42", "08:50", "09:00", "09:10", "09:20",
                            "09:30", "09:40", "09:50", "10:00", "10:12", "10:24", "10:36", "10:48",
                            "11:00", "11:12", "11:24", "11:36", "11:48", "12:00", "12:12", "12:24",
                            "12:36", "12:48", "13:00", "13:12", "13:24", "13:36", "13:48", "14:00",
                            "14:12", "14:24", "14:36", "14:48", "15:00", "15:12", "15:24", "15:36",
                            "15:48", "16:00", "16:12", "16:24", "16:36", "16:48", "17:00", "17:10",
                            "17:20", "17:30", "17:40", "17:50", "18:00", "18:10", "18:20", "18:30",
                            "18:40", "18:50", "19:00", "19:12", "19:24", "19:36", "19:48", "20:00",
                            "20:12", "20:24", "20:36", "20:48", "21:00", "21:12", "21:24", "21:36",
                            "21:48", "22:00", "22:12", "22:24", "22:36", "22:48", "23:00", "23:15",
                            "23:30", "23:45"
                        ]
                    }
                },
                "Tsuen Wan <-> Park Island": { 
                    weekday: { direction1Name: "To Park Island (Bus)", direction1Times: ["07:00", "07:30", "08:00", "08:30", "16:30", "17:00", "17:30", "18:00", "19:00", "20:00"], direction2Name: "To Tsuen Wan (Bus)", direction2Times: ["07:20", "07:50", "08:20", "08:50", "16:50", "17:20", "17:50", "18:20", "19:20", "20:20"] },
                    saturday: { direction1Name: "To Park Island (Bus)", direction1Times: ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00", "17:00", "18:00"], direction2Name: "To Tsuen Wan (Bus)", direction2Times: ["09:30", "10:30", "11:30", "12:30", "14:30", "15:30", "16:30", "17:30", "18:30"] },
                    sundayPublicHoliday: { direction1Name: "To Park Island (Bus)", direction1Times: ["10:00", "11:30", "13:00", "14:30", "16:00", "17:30"], direction2Name: "To Tsuen Wan (Bus)", direction2Times: ["10:45", "12:15", "13:45", "15:15", "16:45", "18:15"] }
                },
                 "Central Pier <-> Park Island": { 
                    weekday: { direction1Name: "To Park Island (Ferry)", direction1Times: ["07:00", "07:30", "08:00", "08:30", "09:00", "17:00", "17:30", "18:00", "18:30", "19:00"], direction2Name: "To Central Pier (Ferry)", direction2Times: ["07:15", "07:45", "08:15", "08:45", "09:15", "17:15", "17:45", "18:15", "18:45", "19:15"] },
                    saturday: { direction1Name: "To Park Island (Ferry)", direction1Times: ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"], direction2Name: "To Central Pier (Ferry)", direction2Times: ["08:30", "09:30", "10:30", "11:30", "12:30", "13:30", "14:30", "15:30", "16:30", "17:30"] },
                    sundayPublicHoliday: { direction1Name: "To Park Island (Ferry)", direction1Times: ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00"], direction2Name: "To Central Pier (Ferry)", direction2Times: ["09:30", "10:30", "11:30", "12:30", "13:30", "14:30", "15:30", "16:30"] }
                },
                "Tsuen Wan Pier <-> Park Island": { 
                    weekday: { direction1Name: "To Park Island (Ferry)", direction1Times: ["07:10", "07:40", "08:10", "08:40", "17:10", "17:40", "18:10", "18:40"], direction2Name: "To Tsuen Wan Pier (Ferry)", direction2Times: ["07:25", "07:55", "08:25", "08:55", "17:25", "17:55", "18:25", "18:55"] },
                    saturday: { direction1Name: "To Park Island (Ferry)", direction1Times: ["08:15", "09:15", "10:15", "11:15", "12:15", "13:15", "14:15", "15:15"], direction2Name: "To Tsuen Wan Pier (Ferry)", direction2Times: ["08:45", "09:45", "10:45", "11:45", "12:45", "13:45", "14:45", "15:45"] },
                    sundayPublicHoliday: { direction1Name: "To Park Island (Ferry)", direction1Times: ["09:20", "10:20", "11:20", "12:20", "13:20", "14:20"], direction2Name: "To Tsuen Wan Pier (Ferry)", direction2Times: ["09:50", "10:50", "11:50", "12:50", "13:50", "14:50"] }
                }
            },
            train: mtrApiConfig 
        };

        // DOM Elements
        const currentTimeEl = document.getElementById('current-time');
        const currentDayDateEl = document.getElementById('current-day-date'); 
        const currentTimeScheduleEl = document.getElementById('current-time-schedule');
        const currentDayDateScheduleEl = document.getElementById('current-day-date-schedule');
        const busRouteSelect = document.getElementById('bus-route-select');
        const trainLineSelect = document.getElementById('train-line-select'); 
        const trainStationSelect = document.getElementById('train-station-select');
        const staticBusRouteSelect = document.getElementById('static-bus-route-select');
        const scheduleTypeSelectorContainer = document.getElementById('schedule-type-selector-container');
        const staticBusScheduleTableContainer = document.getElementById('static-bus-schedule-table-container');
        const favoriteBusRouteSelect = document.getElementById('favorite-bus-route-select');
        const favoriteTrainLineSelect = document.getElementById('favorite-train-line-select'); 
        const favoriteTrainStationSelect = document.getElementById('favorite-train-station-select');
        const saveFavoriteBusButton = document.getElementById('save-favorite-bus');
        const saveFavoriteTrainButton = document.getElementById('save-favorite-train');
        const settingsSavedMessageEl = document.getElementById('settings-saved-message');
        const allTabButtons = document.querySelectorAll('.bottom-nav-button'); 
        const contentPanes = document.querySelectorAll('.content-pane');
        let currentStaticScheduleType = 'weekday'; // Default static schedule type
        let trainDataCache = {}; // Cache for MTR API responses

        // Tab Navigation Logic
        allTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab; 
                
                // Reset all buttons to inactive state
                allTabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    const iconWrapper = btn.querySelector('.bottom-nav-icon-wrapper');
                    if (iconWrapper) iconWrapper.style.backgroundColor = 'transparent';
                    const svgIcon = btn.querySelector('svg');
                    if (svgIcon) svgIcon.style.stroke = 'var(--app-icon-inactive-color)';
                    const navText = btn.querySelector('.nav-text');
                    if (navText) {
                        navText.style.color = 'var(--app-text-inactive-color)';
                        navText.style.fontWeight = 'normal';
                    }
                });

                // Set clicked button to active state
                button.classList.add('active');
                const activeIconWrapper = button.querySelector('.bottom-nav-icon-wrapper');
                if (activeIconWrapper) activeIconWrapper.style.backgroundColor = 'var(--app-nav-icon-active-bg)';
                const activeSvgIcon = button.querySelector('svg');
                if (activeSvgIcon) activeSvgIcon.style.stroke = 'var(--app-accent-color)';
                const activeNavText = button.querySelector('.nav-text');
                if (activeNavText) {
                    activeNavText.style.color = 'var(--app-text-active-color)';
                    activeNavText.style.fontWeight = '600';
                }
                
                // Switch content panes
                contentPanes.forEach(pane => {
                    pane.classList.remove('active'); // Remove active from all
                    if (pane.id === `${targetTab}-pane`) {
                        pane.classList.add('active'); // Add active to the target
                    }
                });


                // Actions specific to tabs
                if (targetTab === 'home') updateLiveSchedules();
                if (targetTab === 'schedule') { 
                    updateDateTimeDisplay(new Date(), true); // Update time for schedule tab
                    // If no route is selected in static schedule, select the first valid one
                    if (staticBusRouteSelect.value === "" && staticBusRouteSelect.options.length > 1) {
                         if (staticBusRouteSelect.options[0].value === "") staticBusRouteSelect.selectedIndex = 1; // Skip "Select a Route"
                    }
                    displayStaticBusSchedule(staticBusRouteSelect.value, currentStaticScheduleType); 
                }
            });
        });
        
        // Get current day type (weekday, saturday, sundayPublicHoliday)
        function getCurrentDayType(date) {
            const day = date.getDay(); // 0 for Sunday, 6 for Saturday
            // TODO: Add public holiday check here if an API or list is available
            if (day === 0) return 'sundayPublicHoliday';
            if (day === 6) return 'saturday';
            return 'weekday';
        }

        // Update date and time display
        function updateDateTimeDisplay(now, isScheduleTab = false) {
            const timeEl = isScheduleTab ? currentTimeScheduleEl : currentTimeEl;
            const dateEl = isScheduleTab ? currentDayDateScheduleEl : currentDayDateEl;

            if (timeEl) timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
            if (dateEl) {
                 dateEl.textContent = `${now.toLocaleDateString([], { weekday: 'long' })}, ${now.toLocaleDateString([], { month: 'long', day: 'numeric', year: 'numeric' })}`;
            }
        }
        
        // Populate train station select based on chosen line
        function populateTrainStations(lineSelectElement, stationSelectElement, selectedLineName, selectedStationNameToSet) {
            stationSelectElement.innerHTML = ''; // Clear existing options
            const lineConfig = mtrApiConfig[selectedLineName]; 
            if (selectedLineName && lineConfig) {
                // Ensure consistent station order for TCL, otherwise use order from config
                const stationNames = (lineConfig.apiLineCode === "TCL") 
                    ? ["Tung Chung", "Sunny Bay", "Tsing Yi", "Lai King", "Nam Cheong", "Olympic", "Kowloon", "Hong Kong"]
                    : Object.keys(lineConfig.stations);

                stationNames.forEach(stationName => {
                    if (lineConfig.stations[stationName]) { // Check if station exists in config for the line
                        const option = document.createElement('option');
                        option.value = stationName; 
                        option.textContent = stationName;
                        stationSelectElement.appendChild(option);
                    }
                });
                // Set the selected station if provided and valid, otherwise select the first
                if (selectedStationNameToSet && stationSelectElement.querySelector(`option[value="${selectedStationNameToSet}"]`)) {
                    stationSelectElement.value = selectedStationNameToSet;
                } else if (stationSelectElement.options.length > 0) {
                    stationSelectElement.selectedIndex = 0; 
                }
            } else { 
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Select Station";
                stationSelectElement.appendChild(defaultOption);
            }
        }
        
        // Populate all select dropdowns
        function populateAllSelectors() {
            // Populate Bus Route Selectors (Home and Settings)
            [busRouteSelect, favoriteBusRouteSelect].forEach(sel => {
                if(sel) {
                    const currentValue = sel.value; // Preserve current selection if any
                    sel.innerHTML = ''; // Clear existing
                     if (sel === favoriteBusRouteSelect) { // Add "None" option for favorite bus
                        const defaultOption = document.createElement('option');
                        defaultOption.value = "";
                        defaultOption.textContent = "None"; 
                        sel.appendChild(defaultOption);
                    }
                    Object.keys(mockSchedules.bus).forEach(routeName => {
                        const option = document.createElement('option');
                        option.value = routeName;
                        option.textContent = routeName;
                        sel.appendChild(option);
                    });
                    if (sel.querySelector(`option[value="${currentValue}"]`)) sel.value = currentValue;
                }
            });

            // Populate Static Bus Route Selector (Schedule Tab)
            if (staticBusRouteSelect) {
                const currentValue = staticBusRouteSelect.value;
                staticBusRouteSelect.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Select a Route and Direction";
                staticBusRouteSelect.appendChild(defaultOption);

                Object.keys(mockSchedules.bus).forEach(routeName => {
                    const routeData = mockSchedules.bus[routeName];
                    // Get direction names from any available day type (weekday, sat, sun/ph)
                    const scheduleForNames = routeData.weekday || routeData.saturday || routeData.sundayPublicHoliday; 
                    if (scheduleForNames) {
                        const dir1Name = (scheduleForNames.direction1Name || 'Direction 1').replace(/\s\(.*\)$/, ''); // Remove (Bus/Ferry)
                        const dir2Name = (scheduleForNames.direction2Name || 'Direction 2').replace(/\s\(.*\)$/, ''); // Remove (Bus/Ferry)

                        const option1 = document.createElement('option');
                        option1.value = `${routeName}__direction1Times`; // Value includes route and direction key
                        option1.textContent = `${routeName} | ${dir1Name}`;
                        staticBusRouteSelect.appendChild(option1);

                        const option2 = document.createElement('option');
                        option2.value = `${routeName}__direction2Times`; 
                        option2.textContent = `${routeName} | ${dir2Name}`;
                        staticBusRouteSelect.appendChild(option2);
                    }
                });
                if (staticBusRouteSelect.querySelector(`option[value="${currentValue}"]`)) staticBusRouteSelect.value = currentValue;
            }

            // Populate Train Line Selectors (Home and Settings)
            [trainLineSelect, favoriteTrainLineSelect].forEach(sel => {
                if (sel) {
                    const currentValue = sel.value;
                    sel.innerHTML = '';
                    if (sel === favoriteTrainLineSelect) { // Add "None" for favorite train line
                        const noneOption = document.createElement('option');
                        noneOption.value = "";
                        noneOption.textContent = "None";
                        sel.appendChild(noneOption);
                    }
                    Object.keys(mtrApiConfig).forEach(lineName => { 
                        const option = document.createElement('option');
                        option.value = lineName; 
                        option.textContent = lineName;
                        sel.appendChild(option);
                    });
                    if (sel.querySelector(`option[value="${currentValue}"]`)) {
                        sel.value = currentValue;
                    } else if (sel === trainLineSelect && sel.options.length > 0) {
                        // Default to first actual line for home screen if previous selection is invalid
                        const firstValidOption = Object.keys(mtrApiConfig)[0];
                        if (firstValidOption) sel.value = firstValidOption;
                    }
                }
            });
            
            // Populate initial train stations based on default/selected line for Home
            const defaultHomeLine = trainLineSelect.value;
            const defaultHomeStation = mtrApiConfig[defaultHomeLine] ? mtrApiConfig[defaultHomeLine].defaultStationName : "Tsing Yi"; // Fallback if needed
            populateTrainStations(trainLineSelect, trainStationSelect, defaultHomeLine, defaultHomeStation);

            // Populate initial train stations based on default/selected line for Settings
            const defaultFavLine = favoriteTrainLineSelect.value;
            const defaultFavStation = mtrApiConfig[defaultFavLine] ? mtrApiConfig[defaultFavLine].defaultStationName : ""; // No station if "None" line
            populateTrainStations(favoriteTrainLineSelect, favoriteTrainStationSelect, defaultFavLine, defaultFavStation);
        }
        
        // Fetch train schedule from MTR API
        async function fetchTrainSchedule(lineName, stationName) {
            const lineConfig = mtrApiConfig[lineName];
            if (!lineConfig || !lineConfig.stations[stationName]) {
                console.error("Invalid line or station for MTR API:", lineName, stationName);
                return null;
            }
            const lineCode = lineConfig.apiLineCode;
            const stationCode = lineConfig.stations[stationName];
            const cacheKey = `${lineCode}-${stationCode}`;
            const apiUrl = `https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=${lineCode}&sta=${stationCode}&lang=EN`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error("MTR API request failed:", response.status);
                    return trainDataCache[cacheKey] || null; // Return cached data on error if available
                }
                const data = await response.json();
                if (data.status === 1 && data.data && data.data[cacheKey]) {
                    trainDataCache[cacheKey] = data.data[cacheKey]; // Update cache
                    return data.data[cacheKey];
                } else if (data.status === 0) { // Special message (e.g., service suspension)
                    console.warn("MTR API special message:", data.message);
                    return { specialMessage: data.message, alertUrl: data.url }; 
                } else {
                    console.warn("MTR API returned no schedule data or unexpected format:", data);
                    return trainDataCache[cacheKey] || null; // Return cached data if available
                }
            } catch (error) {
                console.error("Error fetching MTR schedule:", error);
                return trainDataCache[cacheKey] || null; // Return cached data on network error if available
            }
        }

        // Format minutes left for display
        function formatMinutesLeft(totalMinutes) {
            if (totalMinutes <= 1) return 'Now!';
            if (totalMinutes < 60) return `${totalMinutes}min`;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            let hourText = `${hours}h`;
            if (minutes === 0) return hourText;
            let minuteText = String(minutes).padStart(2, '0') + 'min'; 
            return `${hourText} ${minuteText}`;
        }
        
        // Get next N arrivals for a given schedule
        function getNextArrivals(currentScheduleTimes, now, routeName, directionKey, currentDayTypeForBusRoute) {
            const upcoming = [];
            const MAX_ARRIVALS_TO_SHOW = 3;

            // Check current day's schedule
            if (currentScheduleTimes && currentScheduleTimes.length > 0) {
                for (const timeStr of currentScheduleTimes) {
                    if (timeStr === "N/A" || !timeStr) continue;
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    const scheduleDateTime = new Date(now);
                    scheduleDateTime.setHours(hours, minutes, 0, 0);

                    if (scheduleDateTime >= now) {
                        const diffMs = scheduleDateTime - now;
                        const diffTotalMinutes = Math.ceil(diffMs / 60000);
                        upcoming.push({ time: timeStr, minutesLeft: diffTotalMinutes, isNextDay: false });
                        if (upcoming.length === MAX_ARRIVALS_TO_SHOW) break;
                    }
                }
            }

            // If not enough arrivals, check next day's schedule (only for bus mock data)
            if (routeName && upcoming.length < MAX_ARRIVALS_TO_SHOW) {
                const tomorrowDate = new Date(now);
                tomorrowDate.setDate(now.getDate() + 1); // Get tomorrow's date
                const nextDayType = getCurrentDayType(tomorrowDate); // Determine day type for tomorrow

                const routeScheduleAllTypes = mockSchedules.bus[routeName];
                let nextDayScheduleData = null;
                if (routeScheduleAllTypes) {
                    nextDayScheduleData = routeScheduleAllTypes[nextDayType];
                }

                if (nextDayScheduleData && nextDayScheduleData[directionKey]) {
                    const nextDayTimes = nextDayScheduleData[directionKey];
                    for (const timeStr of nextDayTimes) {
                        if (upcoming.length >= MAX_ARRIVALS_TO_SHOW) break;

                        const [hours, minutes] = timeStr.split(':').map(Number);
                        const nextDayScheduleDateTime = new Date(tomorrowDate); // Use tomorrow's date object
                        nextDayScheduleDateTime.setHours(hours, minutes, 0, 0);
                        
                        const diffMs = nextDayScheduleDateTime - now; // Difference from *now* to next day's time
                        const diffTotalMinutes = Math.ceil(diffMs / 60000);
                        upcoming.push({ time: timeStr, minutesLeft: diffTotalMinutes, isNextDay: true });
                    }
                }
            }
            return upcoming;
        }


        // Display live schedule (bus or train) on Home pane
        async function displayLiveSchedule(type, selectedValue, now, selectedLineValue) { 
            let scheduleData; 
            let dir1DisplayHeader = "Direction 1";
            let dir2DisplayHeader = "Direction 2";
            let apiTrainData = null;
            let lineConfig = null;
            let currentDayTypeForBusRoute = getCurrentDayType(now); // For bus schedules

            const dir1TimesEl = document.getElementById(`${type}-direction1-times`);
            const dir2TimesEl = document.getElementById(`${type}-direction2-times`);

            if (type === 'bus') {
                const routeScheduleAllTypes = mockSchedules.bus[selectedValue];
                if (routeScheduleAllTypes) {
                    scheduleData = routeScheduleAllTypes[currentDayTypeForBusRoute];
                    if (scheduleData) { 
                        dir1DisplayHeader = (scheduleData.direction1Name || "Direction 1").replace(/\s\([\w\s\/]+\)$/, ''); // Remove (Bus/Ferry)
                        dir2DisplayHeader = (scheduleData.direction2Name || "Direction 2").replace(/\s\([\w\s\/]+\)$/, '');
                    }
                }
            } else if (type === 'train') {
                lineConfig = mtrApiConfig[selectedLineValue];
                if (lineConfig && lineConfig.stations[selectedValue]) {
                    // Show loading only if list is currently empty
                    if (dir1TimesEl && dir2TimesEl && !dir1TimesEl.hasChildNodes() && !dir2TimesEl.hasChildNodes()) { 
                        if(dir1TimesEl) dir1TimesEl.innerHTML = '<li class="loading-text text-sm">Loading train times...</li>';
                        if(dir2TimesEl) dir2TimesEl.innerHTML = '';
                    }
                    apiTrainData = await fetchTrainSchedule(selectedLineValue, selectedValue);
                    dir1DisplayHeader = lineConfig.endpoint1NameForDisplay; 
                    dir2DisplayHeader = lineConfig.endpoint2NameForDisplay;
                }
            }

            const dir1NameEl = document.getElementById(`${type}-direction1-name`);
            const dir2NameEl = document.getElementById(`${type}-direction2-name`);

            if (dir1NameEl) dir1NameEl.textContent = dir1DisplayHeader;
            if (dir2NameEl) dir2NameEl.textContent = dir2DisplayHeader;
            
            // Helper to render train arrivals from API data
            const renderArrivalsFromAPI = (apiData, targetEl, targetDestCodeOrCodes) => {
                if (!targetEl) return; // Guard against null element
                targetEl.innerHTML = ''; // Clear previous times
                let arrivalsForThisDisplayDirection = [];

                // Consolidate UP and DOWN arrays if they exist and filter by destination
                const processDirection = (directionArray) => { 
                    if (apiData && directionArray && directionArray.length > 0) {
                        for (const train of directionArray) {
                            if (train.valid === "Y") { // Only consider valid trains
                                // Check if train.dest matches one of the targetDestCodeOrCodes
                                const matchesTarget = Array.isArray(targetDestCodeOrCodes) ? 
                                                      targetDestCodeOrCodes.includes(train.dest) : 
                                                      train.dest === targetDestCodeOrCodes;
                                if (matchesTarget) {
                                    arrivalsForThisDisplayDirection.push(train);
                                }
                            }
                        }
                    }
                };

                processDirection(apiData?.UP);
                processDirection(apiData?.DOWN);
                
                // Sort all matching trains by time to next train (ttnt)
                arrivalsForThisDisplayDirection.sort((a, b) => parseInt(a.ttnt) - parseInt(b.ttnt));

                if (arrivalsForThisDisplayDirection.length > 0) {
                    let count = 0;
                    arrivalsForThisDisplayDirection.forEach((train, index) => {
                        if (count < 3) { // Show up to 3 arrivals
                            const li = document.createElement('li');
                            li.className = 'py-0.5 flex justify-between items-center w-full';
                            const arrivalTime = new Date(train.time); // API time is a full timestamp
                            const displayTime = arrivalTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                            const minutesText = formatMinutesLeft(parseInt(train.ttnt));
                            
                            const isFirstItem = index === 0;
                            const timeClass = isFirstItem ? 'font-semibold text-sm text-[var(--app-accent-color)]' : 'font-medium text-sm text-gray-500'; 
                            const waitingTimeClass = minutesText === 'Now!' ? 'text-now-emphasis text-right' : 'text-gray-500 text-right';
                            const waitingTimeSizeClass = isFirstItem ? 'text-sm' : 'text-sm';
                            const waitingTimeBoldClass = isFirstItem ? 'font-semibold' : '';
                            const waitingTimeColorClass = isFirstItem && minutesText !== 'Now!' ? 'text-[var(--app-accent-color)]' : '';

                            li.innerHTML = `<span class="${timeClass}">${displayTime}</span> <span class="${waitingTimeClass} ${waitingTimeBoldClass} ${waitingTimeSizeClass} ${waitingTimeColorClass}">${minutesText}</span>`;
                            targetEl.appendChild(li);
                            count++;
                        }
                    });
                     if (count === 0) { // If after filtering, no valid trains for this specific direction
                         targetEl.innerHTML = '<li class="italic text-gray-500 text-sm">No valid upcoming trains for this direction.</li>';
                    }
                } else if (apiData && apiData.specialMessage) {
                     targetEl.innerHTML = `<li class="italic text-orange-600 text-sm">${apiData.specialMessage}</li>`;
                }
                 else {
                    targetEl.innerHTML = '<li class="italic text-gray-500 text-sm">No services for this direction.</li>';
                }
            };

            // Helper to render bus arrivals from mock data
            const renderArrivalsFromMock = (arrivals, targetEl) => {
                if (!targetEl) return; // Guard against null element
                targetEl.innerHTML = '';
                if (!arrivals || arrivals.length === 0) {
                    targetEl.innerHTML = '<li class="italic text-gray-500 text-sm">No further services found.</li>';
                } else {
                    arrivals.forEach((arr, index) => {
                        const li = document.createElement('li');
                        li.className = 'py-0.5 flex justify-between items-center w-full'; 
                        const minutesText = formatMinutesLeft(arr.minutesLeft);
                        
                        const isFirstItem = index === 0;
                        const timeClass = isFirstItem ? 'font-semibold text-sm text-[var(--app-accent-color)]' : 'font-medium text-sm text-gray-500'; 
                        const waitingTimeClass = minutesText === 'Now!' ? 'text-now-emphasis text-right' : 'text-gray-600 text-right';
                        const waitingTimeSizeClass = isFirstItem ? 'text-sm' : 'text-sm';
                        const waitingTimeBoldClass = isFirstItem ? 'font-semibold' : '';
                        const waitingTimeColorClass = isFirstItem && minutesText !== 'Now!' ? 'text-[var(--app-accent-color)]' : '';

                        const timeDisplayString = arr.time;
                        li.innerHTML = `<span class="${timeClass}">${timeDisplayString}</span><span class="${waitingTimeClass} ${waitingTimeBoldClass} ${waitingTimeSizeClass} ${waitingTimeColorClass}">${minutesText}</span>`;
                        targetEl.appendChild(li);
                    });
                }
            };

            if (type === 'train') {
                if (apiTrainData && lineConfig) {
                    renderArrivalsFromAPI(apiTrainData, dir1TimesEl, lineConfig.endpoint1ActualDestCode);
                    renderArrivalsFromAPI(apiTrainData, dir2TimesEl, lineConfig.endpoint2ActualDestCode);
                } else if (!apiTrainData && dir1TimesEl && dir2TimesEl && (!dir1TimesEl.hasChildNodes() && !dir2TimesEl.hasChildNodes())) { // Only show error if not already loading
                    if(dir1TimesEl) dir1TimesEl.innerHTML = '<li class="italic text-gray-500 text-sm">Could not load schedule.</li>';
                    if(dir2TimesEl) dir2TimesEl.innerHTML = '<li class="italic text-gray-500 text-sm">Could not load schedule.</li>';
                }
            } else { // Bus
                if (!scheduleData || !scheduleData.direction1Times || !scheduleData.direction2Times) { 
                    if(dir1TimesEl) dir1TimesEl.innerHTML = '<li class="italic text-gray-500 text-sm">No data available.</li>';
                    if(dir2TimesEl) dir2TimesEl.innerHTML = '<li class="italic text-gray-500 text-sm">No data available.</li>';
                    return;
                }
                if (dir1TimesEl) renderArrivalsFromMock(getNextArrivals(scheduleData.direction1Times, now, selectedValue, 'direction1Times', currentDayTypeForBusRoute), dir1TimesEl);
                if (dir2TimesEl) renderArrivalsFromMock(getNextArrivals(scheduleData.direction2Times, now, selectedValue, 'direction2Times', currentDayTypeForBusRoute), dir2TimesEl);
            }
        }
        
        // Display static bus schedule on Schedule pane
        function displayStaticBusSchedule(selectedRouteAndDirection, scheduleType) {
            const tableContainer = document.getElementById('static-bus-schedule-table-container');
            const fixedHeaderEl = document.getElementById('static-schedule-fixed-header');
            if (!tableContainer || !fixedHeaderEl) return; // Guard if elements don't exist
            tableContainer.innerHTML = ''; // Clear previous table

            if (!selectedRouteAndDirection) {
                tableContainer.innerHTML = '<p class="text-gray-500 text-sm px-2 sm:px-3">Please select a route, direction, and schedule type.</p>';
                fixedHeaderEl.style.display = 'none'; // Hide header
                return;
            }
            if (!scheduleType) {
                 tableContainer.innerHTML = '<p class="text-gray-500 text-sm px-2 sm:px-3">Please select a schedule type.</p>';
                 fixedHeaderEl.style.display = 'none';
                return;
            }

            const [actualRouteName, directionKeyFromValue] = selectedRouteAndDirection.split('__');
            
            if (!actualRouteName || !directionKeyFromValue) {
                 tableContainer.innerHTML = '<p class="text-red-500 text-sm px-2 sm:px-3">Invalid route selection.</p>';
                 fixedHeaderEl.style.display = 'none';
                return;
            }

            const routeSchedules = mockSchedules.bus[actualRouteName];
            if (!routeSchedules) {
                tableContainer.innerHTML = '<p class="text-red-600 text-sm px-2 sm:px-3">Route data not found.</p>';
                fixedHeaderEl.style.display = 'none';
                return;
            }
            const scheduleDataForType = routeSchedules[scheduleType];
            if (!scheduleDataForType || !scheduleDataForType[directionKeyFromValue]) {
                tableContainer.innerHTML = `<p class="text-red-600 text-sm px-2 sm:px-3">No ${scheduleType.replace(/([A-Z])/g, ' $1').toLowerCase()} schedule found for this route and direction.</p>`;
                fixedHeaderEl.style.display = 'none';
                return;
            }
            
            const timesArray = scheduleDataForType[directionKeyFromValue];
            
            // Group times by hour for table display
            const groupTimesByHour = (arr) => {
                const grouped = {};
                (arr || []).forEach(timeStr => { // Handle potentially undefined/empty array
                    const [hour, minute] = timeStr.split(':');
                    if (!grouped[hour]) grouped[hour] = [];
                    grouped[hour].push(minute);
                });
                return grouped;
            };

            const hourlyTimes = groupTimesByHour(timesArray);
            const sortedHours = Object.keys(hourlyTimes).sort((a, b) => parseInt(a) - parseInt(b));

            if (sortedHours.length === 0) { // Check if there are any times to display
                 tableContainer.innerHTML = `<p class="text-gray-500 text-sm px-2 sm:px-3">No departures found for the selected criteria.</p>`;
                 fixedHeaderEl.style.display = 'none';
                return;
            }
            
            fixedHeaderEl.style.display = 'flex'; // Show header since there's data

            const table = document.createElement('table');
            const tbody = document.createElement('tbody');

            sortedHours.forEach(hourStr => {
                const tr = document.createElement('tr');
                
                const tdHour = document.createElement('td');
                tdHour.className = 'hour-cell'; // Class handles width and specific styling
                tdHour.textContent = hourStr;
                tr.appendChild(tdHour);

                const tdDirMinutes = document.createElement('td');
                tdDirMinutes.className = 'minutes-cell'; // Class handles width and specific styling
                if (hourlyTimes[hourStr]) {
                    hourlyTimes[hourStr].forEach(minute => {
                        const span = document.createElement('span');
                        span.className = 'minute-item';
                        span.textContent = minute;
                        tdDirMinutes.appendChild(span);
                    });
                } else {
                    tdDirMinutes.textContent = '--'; 
                }
                tr.appendChild(tdDirMinutes);
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);
        }
        
        // Load user preferences from localStorage
        function loadPreferences() {
            const favBus = localStorage.getItem('favoriteBusRoute');
            const favTrainLine = localStorage.getItem('favoriteTrainLine');
            const favTrainStation = localStorage.getItem('favoriteTrainStation');

            // Set favorite bus route on Home and Settings
            if (favBus && busRouteSelect && busRouteSelect.querySelector(`option[value="${favBus}"]`)) busRouteSelect.value = favBus;
            if (favBus && favoriteBusRouteSelect && favoriteBusRouteSelect.querySelector(`option[value="${favBus}"]`)) favoriteBusRouteSelect.value = favBus;
            
            // Set favorite train line and station for Home screen
            let homeLineVal = favTrainLine || Object.keys(mtrApiConfig)[0]; // Default to first line if no fav
            if (trainLineSelect) {
                if (trainLineSelect.querySelector(`option[value="${homeLineVal}"]`)) {
                    trainLineSelect.value = homeLineVal;
                } else if (trainLineSelect.options.length > 0) { // Fallback if fav line is somehow invalid
                    trainLineSelect.value = trainLineSelect.options[0].value;
                }
            }

            let homeStationVal = favTrainStation;
            // If there's a selected line but no fav station, use the line's default station
            if (trainLineSelect && trainLineSelect.value && mtrApiConfig[trainLineSelect.value] && !favTrainStation) {
                homeStationVal = mtrApiConfig[trainLineSelect.value].defaultStationName;
            }
            populateTrainStations(trainLineSelect, trainStationSelect, trainLineSelect.value, homeStationVal);

            // Set favorite train line and station for Settings screen
            if (favoriteTrainLineSelect) {
                let favSettingsLineVal = favTrainLine || ""; // Default to "None" if no fav
                 if (favoriteTrainLineSelect.querySelector(`option[value="${favSettingsLineVal}"]`)) {
                    favoriteTrainLineSelect.value = favSettingsLineVal;
                } else {
                     favoriteTrainLineSelect.value = ""; // Fallback to "None"
                }

                let favSettingsStationVal = favTrainStation;
                 // If a line is selected in settings but no station, try to set its default
                 if (!favSettingsStationVal && favoriteTrainLineSelect.value && mtrApiConfig[favoriteTrainLineSelect.value]) {
                    favSettingsStationVal = mtrApiConfig[favoriteTrainLineSelect.value].defaultStationName;
                }
                populateTrainStations(favoriteTrainLineSelect, favoriteTrainStationSelect, favoriteTrainLineSelect.value, favSettingsStationVal);
            }
        }

        // Show "Settings Saved" message
        function showSettingsSavedMessage() {
            settingsSavedMessageEl.classList.remove('hidden');
            settingsSavedMessageEl.classList.add('show');
            setTimeout(() => {
                settingsSavedMessageEl.classList.remove('show');
                setTimeout(() => settingsSavedMessageEl.classList.add('hidden'), 500); // Wait for fade out
            }, 2500);
        }


        // Event Listeners for Saving Preferences
        if(saveFavoriteBusButton) saveFavoriteBusButton.addEventListener('click', () => {
            const selectedFavBus = favoriteBusRouteSelect.value;
            localStorage.setItem('favoriteBusRoute', selectedFavBus);
            // Update home screen bus route if a favorite is set
            if (busRouteSelect && selectedFavBus && busRouteSelect.querySelector(`option[value="${selectedFavBus}"]`)) busRouteSelect.value = selectedFavBus;
            showSettingsSavedMessage();
            updateLiveSchedules(); // Refresh home screen with new preference
        });

        if(saveFavoriteTrainButton) saveFavoriteTrainButton.addEventListener('click', () => {
            const selectedFavTrainLine = favoriteTrainLineSelect.value;
            const selectedFavTrainStation = favoriteTrainStationSelect.value;
            localStorage.setItem('favoriteTrainLine', selectedFavTrainLine);
            localStorage.setItem('favoriteTrainStation', selectedFavTrainStation);

            // Update home screen train selectors if a favorite is set
            if (trainLineSelect && selectedFavTrainLine && trainLineSelect.querySelector(`option[value="${selectedFavTrainLine}"]`)) {
                trainLineSelect.value = selectedFavTrainLine;
                populateTrainStations(trainLineSelect, trainStationSelect, selectedFavTrainLine, selectedFavTrainStation);
            } else if (trainLineSelect && trainLineSelect.options.length > 0) { // If "None" is chosen, reset home to default
                 trainLineSelect.value = trainLineSelect.options[0].value; // First actual line
                 populateTrainStations(trainLineSelect, trainStationSelect, trainLineSelect.value, mtrApiConfig[trainLineSelect.value]?.defaultStationName || "");
            }
            showSettingsSavedMessage();
            updateLiveSchedules(); // Refresh home screen
        });
        
        // Update live schedules (called on load, tab change, and interval)
        async function updateLiveSchedules() { 
            const now = new Date();
            const homePaneActive = document.getElementById('home-pane').classList.contains('active');
            const schedulePaneActive = document.getElementById('schedule-pane').classList.contains('active');


            // Update date/time display for the active pane
            if (homePaneActive) updateDateTimeDisplay(now, false);
            if (schedulePaneActive) updateDateTimeDisplay(now, true);


            // Only update schedule content if Home pane is active
            if (homePaneActive) {
                // Update Bus Schedule
                const currentBusRoute = busRouteSelect.value;
                if (currentBusRoute) {
                    await displayLiveSchedule('bus', currentBusRoute, now); 
                } else if (busRouteSelect.options.length > 1 && busRouteSelect.options[0].value === "") { 
                    busRouteSelect.selectedIndex = 1; // Select first actual route if "Select a Route" is an option and nothing chosen
                    await displayLiveSchedule('bus', busRouteSelect.value, now);
                } else if (busRouteSelect.options.length > 0) {
                     busRouteSelect.selectedIndex = 0; // Select first route if available
                    await displayLiveSchedule('bus', busRouteSelect.value, now);
                }

                // Update Train Schedule
                let currentTrainLine = trainLineSelect.value;
                let currentTrainStation = trainStationSelect.value;

                // Ensure a line is selected if possible
                if (!currentTrainLine && trainLineSelect.options.length > 0) {
                    for(let i=0; i < trainLineSelect.options.length; i++) {
                        if(trainLineSelect.options[i].value) { // Find first non-empty option (skip "None" if it were there)
                            currentTrainLine = trainLineSelect.options[i].value;
                            trainLineSelect.value = currentTrainLine;
                            break;
                        }
                    }
                }
                
                // If a line is selected, ensure station is valid or set to default
                if (currentTrainLine && trainStationSelect) { 
                    const lineData = mtrApiConfig[currentTrainLine]; 
                    if (!lineData || !lineData.stations[currentTrainStation]) {
                        const defaultStationForLine = lineData ? lineData.defaultStationName : "";
                        populateTrainStations(trainLineSelect, trainStationSelect, currentTrainLine, defaultStationForLine); 
                        currentTrainStation = trainStationSelect.value; 
                    }
                }

                if (currentTrainLine && currentTrainStation) {
                    await displayLiveSchedule('train', currentTrainStation, now, currentTrainLine);
                } else { 
                    const dir1NameEl = document.getElementById(`train-direction1-name`);
                    const dir1TimesEl = document.getElementById(`train-direction1-times`);
                    const dir2NameEl = document.getElementById(`train-direction2-name`);
                    const dir2TimesEl = document.getElementById(`train-direction2-times`);
                    if(dir1NameEl) dir1NameEl.textContent = 'Direction 1';
                    if(dir2NameEl) dir2NameEl.textContent = 'Direction 2';
                    if(dir1TimesEl) dir1TimesEl.innerHTML = '<li class="italic text-gray-500 text-sm">Select line & station.</li>';
                    if(dir2TimesEl) dir2TimesEl.innerHTML = '';
                }
            }
        }
        
        // Event Listeners for Home screen selectors
        if (busRouteSelect) busRouteSelect.addEventListener('change', () => updateLiveSchedules());
        if (trainLineSelect) {
            trainLineSelect.addEventListener('change', () => {
                const lineConfig = mtrApiConfig[trainLineSelect.value];
                const defaultStation = lineConfig ? lineConfig.defaultStationName : "";
                populateTrainStations(trainLineSelect, trainStationSelect, trainLineSelect.value, defaultStation); 
                updateLiveSchedules(); 
            });
        }
        if (trainStationSelect) trainStationSelect.addEventListener('change', () => updateLiveSchedules());

        // Event Listener for Favorite Train Line (in Settings) to update its station list
        if (favoriteTrainLineSelect) {
            favoriteTrainLineSelect.addEventListener('change', () => {
                const lineConfig = mtrApiConfig[favoriteTrainLineSelect.value];
                const defaultStation = lineConfig ? lineConfig.defaultStationName : ""; // Default station or empty if "None"
                populateTrainStations(favoriteTrainLineSelect, favoriteTrainStationSelect, favoriteTrainLineSelect.value, defaultStation);
            });
        }

        // Event Listeners for Static Schedule selectors
        if (staticBusRouteSelect) {
            staticBusRouteSelect.addEventListener('change', () => {
                displayStaticBusSchedule(staticBusRouteSelect.value, currentStaticScheduleType);
            });
        }

        if (scheduleTypeSelectorContainer) {
            const typeButtons = scheduleTypeSelectorContainer.querySelectorAll('.schedule-type-segment');
            typeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    typeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentStaticScheduleType = button.dataset.scheduletype;
                    displayStaticBusSchedule(staticBusRouteSelect.value, currentStaticScheduleType);
                });
            });
        }

        // Initial Setup on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            populateAllSelectors(); 
            loadPreferences();    
            
            // Set Home tab and pane as active initially
            const firstTabButton = document.querySelector('.bottom-nav-button[data-tab="home"]');
            const homePane = document.getElementById('home-pane');

            // Reset all buttons and panes to ensure a clean start
            allTabButtons.forEach(btn => {
                btn.classList.remove('active');
                // Also reset inline styles that might have been set by JS if not using classes alone
                const iconWrapper = btn.querySelector('.bottom-nav-icon-wrapper');
                if (iconWrapper) iconWrapper.style.backgroundColor = ''; // Reset to CSS default
                const svgIcon = btn.querySelector('svg');
                if (svgIcon) svgIcon.style.stroke = ''; // Reset to CSS default
                const navText = btn.querySelector('.nav-text');
                if (navText) {
                    navText.style.color = ''; // Reset to CSS default
                    navText.style.fontWeight = ''; // Reset to CSS default
                }
            });
            contentPanes.forEach(pane => pane.classList.remove('active'));


            if (firstTabButton) {
                 firstTabButton.classList.add('active'); // CSS will style this based on .active
                 // Manually apply styles for the initially active button to match click behavior
                 const iconWrapper = firstTabButton.querySelector('.bottom-nav-icon-wrapper');
                 if(iconWrapper) iconWrapper.style.backgroundColor = 'var(--app-nav-icon-active-bg)';
                 const svgIcon = firstTabButton.querySelector('svg');
                 if(svgIcon) svgIcon.style.stroke = 'var(--app-accent-color)';
                 const navText = firstTabButton.querySelector('.nav-text');
                 if(navText) {
                    navText.style.color = 'var(--app-text-active-color)';
                    navText.style.fontWeight = '600';
                 }
            }
            if (homePane) {
                homePane.classList.add('active'); 
            }
            
            const fixedHeader = document.getElementById('static-schedule-fixed-header');
            if(fixedHeader) fixedHeader.style.display = 'none'; // Initially hide static schedule header


            updateLiveSchedules(); // Initial schedule load
            setInterval(updateLiveSchedules, 30000); // Refresh live schedules every 30 seconds
            // Update time display every second
            setInterval(() => {
                const now = new Date();
                if (document.getElementById('home-pane')?.classList.contains('active')) {
                    updateDateTimeDisplay(now, false);
                }
                if (document.getElementById('schedule-pane')?.classList.contains('active')) {
                    updateDateTimeDisplay(now, true);
                }
            }, 1000);
        });
    </script>
</body>
</html>
